<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Tawaf AR Trainer - Hajj Pilgrimage Education</title>
    
    <!-- A-Frame and AR.js Loading -->
    <script>
        // Load A-Frame first, then AR.js
        function loadLibraries() {
            console.log('Loading A-Frame and AR.js...');
            
            // First load A-Frame
            const aframeScript = document.createElement('script');
            aframeScript.src = 'https://aframe.io/releases/1.4.0/aframe.min.js';
            aframeScript.onload = function() {
                console.log('A-Frame loaded successfully');
                // Then load AR.js
                loadARJS();
            };
            aframeScript.onerror = function() {
                console.error('Failed to load A-Frame');
                document.getElementById('debugInfo').textContent = 'A-Frame failed to load';
                document.getElementById('debugInfo').style.color = '#f44336';
            };
            document.head.appendChild(aframeScript);
        }
        
        // Try to load AR.js from multiple sources
        function loadARJS() {
            const sources = [
                'https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@master/aframe/build/aframe-ar.min.js',
                'https://unpkg.com/aframe-ar@1.4.2/dist/aframe-ar.min.js',
                'https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.min.js'
            ];
            
            let loaded = false;
            
            sources.forEach((src, index) => {
                if (!loaded) {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = function() {
                        console.log('AR.js loaded successfully from:', src);
                        loaded = true;
                        initializeAR();
                    };
                    script.onerror = function() {
                        console.log('Failed to load AR.js from:', src);
                        if (index === sources.length - 1) {
                            // All sources failed, show error
                            document.getElementById('debugInfo').textContent = 'AR.js failed to load. Using fallback mode.';
                            document.getElementById('debugInfo').style.color = '#FF9800';
                            initializeFallback();
                        }
                    };
                    document.head.appendChild(script);
                }
            });
        }
        
        // Initialize AR when library loads
        function initializeAR() {
            console.log('AR.js initialized successfully');
            document.getElementById('debugInfo').textContent = 'Camera Status: âœ… Working | AR.js: âœ… Loaded';
            document.getElementById('debugInfo').style.color = '#4CAF50';
            
            // Update status
            updateStatus('AR.js loaded successfully', 'status-tracking');
            
            // Show AR scene
            const arScene = document.getElementById('arScene');
            if (arScene) {
                arScene.style.display = 'block';
                console.log('AR scene should now be visible');
            }
            
            // Setup AR events
            setTimeout(setupAREvents, 1000);
            
            // Force canvas to be visible
            setTimeout(() => {
                const canvas = document.querySelector('.a-canvas');
                if (canvas) {
                    canvas.style.display = 'block';
                    console.log('A-Frame canvas should now be visible');
                }
            }, 2000);
        }
        
        // Fallback mode without AR.js
        function initializeFallback() {
            console.log('Using fallback mode without AR.js');
            updateStatus('Using fallback mode - AR.js not available', 'status-error');
            
            // Create a simple camera view
            const video = document.createElement('video');
            video.id = 'cameraFeed';
            video.autoplay = true;
            video.playsinline = true;
            video.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                object-fit: cover;
                z-index: 1;
            `;
            document.body.insertBefore(video, document.body.firstChild);
            
            // Start camera
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    console.log('Camera started in fallback mode');
                    updateStatus('Camera working (fallback mode)', 'status-searching');
                })
                .catch(err => {
                    console.error('Camera error in fallback mode:', err);
                    updateStatus('Camera access denied', 'status-error');
                });
        }
        
        // Load libraries when page loads
        window.addEventListener('load', function() {
            // First check camera availability
            checkCameraStatus();
            // Then load A-Frame and AR.js
            loadLibraries();
        });
    </script>
    
    <!-- Custom styles -->
    <style>
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
        }
        
        /* Make sure camera feed is visible */
        .a-canvas {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 1 !important;
            display: block !important;
        }
        
        /* AR Scene container */
        #arScene {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 1 !important;
        }
        
        /* A-Frame scene */
        a-scene {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
        }
        
        .ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        .ui-panel {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            pointer-events: auto;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .main-menu {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            min-width: 300px;
        }
        
        .tawaf-ui {
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: none;
        }
        
        .settings-panel {
            top: 20px;
            right: 20px;
            display: none;
            min-width: 250px;
        }
        
        .help-panel {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            pointer-events: auto;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #FF9800, #F57C00);
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .corner-indicator {
            position: absolute;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 0, 0.8);
            border-radius: 50%;
            border: 3px solid #FFD700;
            animation: pulse 2s infinite;
            pointer-events: none;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .instruction-text {
            font-size: 18px;
            margin: 15px 0;
            text-align: center;
        }
        
        .round-text {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }
        
        .slider {
            width: 150px;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4CAF50;
            color: white;
            cursor: pointer;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            pointer-events: auto;
        }
        
        .ar-status {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            pointer-events: none;
        }
        
        .status-tracking {
            color: #4CAF50;
        }
        
        .status-searching {
            color: #FF9800;
        }
        
        .status-error {
            color: #F44336;
        }
        
        /* Debug info */
        .debug-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 2000;
            pointer-events: none;
        }
        
        /* Camera feed debug */
        .camera-debug {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border: 2px solid red;
            z-index: 999;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- AR Status Indicator -->
    <div class="ar-status" id="arStatus">
        <span id="statusText">Loading AR components...</span>
    </div>

    <!-- Debug Info -->
    <div class="debug-info" id="debugInfo">
        Loading AR.js...
    </div>
    
    <!-- Visual Debug Display -->
    <div id="visualDebug" style="position: fixed; top: 50px; left: 20px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-size: 12px; z-index: 2000; display: none;">
        <div id="debugStatus">Debug: Ready</div>
    </div>

    <!-- Main Menu -->
    <div class="ui-overlay">
        <div class="ui-panel main-menu" id="mainMenu">
            <h1>ðŸ•‹ Tawaf AR Trainer</h1>
            <p>Learn the Tawaf ritual through Augmented Reality</p>
            <button class="btn" onclick="startTawaf()">Start Tawaf Training</button>
            <button class="btn btn-secondary" onclick="showSettings()">Settings</button>
            <button class="btn btn-secondary" onclick="showHelp()">Help</button>
            <button class="btn btn-warning" onclick="toggleDebug()">Toggle Debug</button>
            <button class="btn btn-secondary" onclick="testImageTracking()">Test Tracking</button>
            <button class="btn btn-secondary" onclick="testCamera()">Test Camera</button>
            <button class="btn btn-secondary" onclick="showARScene()">Show AR Scene</button>
            <button class="btn btn-secondary" onclick="showSimpleCamera()">Show Simple Camera</button>
            <button class="btn btn-secondary" onclick="debugMarkerDetection()">Debug Marker</button>
            <button class="btn btn-secondary" onclick="toggleVisualDebug()">Toggle Visual Debug</button>
            <button class="btn btn-secondary" onclick="reloadLibraries()">Reload Libraries</button>
            <p style="font-size: 12px; margin-top: 20px;">
                Point your camera at a Kaaba image to begin
            </p>
        </div>

        <!-- Tawaf UI -->
        <div class="ui-panel tawaf-ui" id="tawafUI">
            <div class="round-text" id="roundText">Round: 0/7</div>
            <div class="instruction-text" id="instructionText">Point camera at Kaaba image to start</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div style="text-align: center;">
                <button class="btn" id="startBtn" onclick="startTawafRoutine()">Start</button>
                <button class="btn btn-warning" id="pauseBtn" onclick="pauseTawaf()" style="display: none;">Pause</button>
                <button class="btn btn-secondary" onclick="resetTawaf()">Reset</button>
                <button class="btn btn-secondary" onclick="showMainMenu()">Menu</button>
            </div>
        </div>

        <!-- Settings Panel -->
        <div class="ui-panel settings-panel" id="settingsPanel">
            <button class="close-btn" onclick="hideSettings()">&times;</button>
            <h3>Settings</h3>
            <div class="settings-row">
                <span>Master Volume:</span>
                <input type="range" class="slider" id="masterVolume" min="0" max="1" step="0.1" value="1">
            </div>
            <div class="settings-row">
                <span>Prayer Volume:</span>
                <input type="range" class="slider" id="prayerVolume" min="0" max="1" step="0.1" value="0.8">
            </div>
            <div class="settings-row">
                <span>Guidance Volume:</span>
                <input type="range" class="slider" id="guidanceVolume" min="0" max="1" step="0.1" value="0.6">
            </div>
            <div class="settings-row">
                <span>Language:</span>
                <select id="languageSelect" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 5px; border-radius: 5px;">
                    <option value="en">English</option>
                    <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                    <option value="ms">Bahasa Melayu</option>
                </select>
            </div>
            <div class="settings-row">
                <span>Subtitles:</span>
                <input type="checkbox" id="subtitlesToggle" checked>
            </div>
            <button class="btn" onclick="saveSettings()">Save Settings</button>
        </div>

        <!-- Help Panel -->
        <div class="ui-panel help-panel" id="helpPanel">
            <button class="close-btn" onclick="hideHelp()">&times;</button>
            <h3>How to Use Tawaf AR Trainer</h3>
            <div style="text-align: left;">
                <h4>Getting Started:</h4>
                <ol>
                    <li>Print or display a Kaaba image on your screen</li>
                    <li>Point your camera at the image</li>
                    <li>Tap "Start Tawaf Training" when the AR Kaaba appears</li>
                    <li>Follow the audio and visual guidance</li>
                </ol>
                
                <h4>Tawaf Ritual:</h4>
                <ul>
                    <li>Complete 7 rounds around the Kaaba</li>
                    <li>Start from the Black Stone corner</li>
                    <li>Move counterclockwise</li>
                    <li>Recite prayers at each corner</li>
                </ul>
                
                <h4>Controls:</h4>
                <ul>
                    <li>Start/Pause: Control the training session</li>
                    <li>Reset: Start over from the beginning</li>
                    <li>Settings: Adjust audio and language</li>
                </ul>
                
                <h4>Tips:</h4>
                <ul>
                    <li>Ensure good lighting for better tracking</li>
                    <li>Keep the Kaaba image visible</li>
                    <li>Move slowly and deliberately</li>
                    <li>Use headphones for better audio experience</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- A-Frame Scene (will be initialized after AR.js loads) -->
    <div id="arScene" style="display: none;">
        <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: true; detectionMode: mono_and_matrix; matrixCodeType: 3x3; sourceWidth: 1280; sourceHeight: 720; displayWidth: 1280; displayHeight: 720; trackingMethod: best;">
            
            <!-- Kaaba 3D Model - Multiple marker support -->
            <!-- Hiro marker (default) -->
            <a-marker preset="hiro" id="kaabaMarker" emitevents="true" cursor="rayOrigin: mouse" raycaster="objects: .clickable">
                <!-- Add a simple visible object to confirm marker detection -->
                <a-box position="0 0.5 0" 
                       rotation="0 0 0" 
                       width="1" 
                       height="1" 
                       depth="1" 
                       color="#8B4513"
                       material="shader: flat"
                       class="clickable">
                    <!-- Black Stone corner indicator -->
                    <a-sphere position="0.5 0.5 0.5" 
                              radius="0.1" 
                              color="#000000"
                              class="corner-marker"
                              data-corner="0">
                    </a-sphere>
                    
                    <!-- Yemen corner indicator -->
                    <a-sphere position="0.5 0.5 -0.5" 
                              radius="0.1" 
                              color="#FFD700"
                              class="corner-marker"
                              data-corner="1">
                    </a-sphere>
                    
                    <!-- Shami corner indicator -->
                    <a-sphere position="-0.5 0.5 -0.5" 
                              radius="0.1" 
                              color="#FFD700"
                              class="corner-marker"
                              data-corner="2">
                    </a-sphere>
                    
                    <!-- Iraqi corner indicator -->
                    <a-sphere position="-0.5 0.5 0.5" 
                              radius="0.1" 
                              color="#FFD700"
                              class="corner-marker"
                              data-corner="3">
                    </a-sphere>
                </a-box>
                
                <!-- Tawaf path -->
                <a-ring position="0 0.01 0" 
                        radius="2" 
                        radius-inner="1.5" 
                        color="#FFFFFF" 
                        opacity="0.3"
                        rotation="-90 0 0">
                </a-ring>
                
                <!-- Direction arrows -->
                <a-entity id="directionArrows" visible="false">
                    <a-cone position="0 0.1 1.5" 
                            rotation="0 0 0" 
                            radius-bottom="0.2" 
                            height="0.4" 
                            color="#4CAF50">
                    </a-cone>
                </a-entity>
            </a-marker>
            
            <!-- Camera -->
            <a-entity camera></a-entity>
            
            <!-- Audio elements -->
            <a-entity id="audioContainer">
                <audio id="prayerAudio" preload="auto"></audio>
                <audio id="guidanceAudio" preload="auto"></audio>
            </a-entity>
        </a-scene>
    </div>

    <!-- JavaScript for Tawaf Logic -->
    <script>
        // Tawaf state
        let currentRound = 0;
        let currentCorner = 0;
        let isTawafActive = false;
        let tawafInterval;
        let debugMode = false;
        
        // Audio elements
        const prayerAudio = document.getElementById('prayerAudio');
        const guidanceAudio = document.getElementById('guidanceAudio');
        
        // UI elements
        const mainMenu = document.getElementById('mainMenu');
        const tawafUI = document.getElementById('tawafUI');
        const settingsPanel = document.getElementById('settingsPanel');
        const helpPanel = document.getElementById('helpPanel');
        const roundText = document.getElementById('roundText');
        const instructionText = document.getElementById('instructionText');
        const progressFill = document.getElementById('progressFill');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const arStatus = document.getElementById('arStatus');
        const statusText = document.getElementById('statusText');
        const debugInfo = document.getElementById('debugInfo');
        
        // Corner names
        const cornerNames = {
            en: ['Black Stone', 'Yemen', 'Shami', 'Iraqi'],
            ar: ['Ø§Ù„Ø­Ø¬Ø± Ø§Ù„Ø£Ø³ÙˆØ¯', 'Ø§Ù„Ø±ÙƒÙ† Ø§Ù„ÙŠÙ…Ø§Ù†ÙŠ', 'Ø§Ù„Ø±ÙƒÙ† Ø§Ù„Ø´Ø§Ù…ÙŠ', 'Ø§Ù„Ø±ÙƒÙ† Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠ'],
            ms: ['Hajar Aswad', 'Rukun Yamani', 'Rukun Shami', 'Rukun Iraqi']
        };
        
        // Instructions
        const instructions = {
            en: {
                start: 'Point camera at Kaaba image to start',
                goToCorner: 'Go to {corner} corner',
                complete: 'Tawaf completed! Congratulations!',
                pause: 'Tawaf paused. Tap Resume to continue.'
            },
            ar: {
                start: 'ÙˆØ¬Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ ØµÙˆØ±Ø© Ø§Ù„ÙƒØ¹Ø¨Ø© Ù„Ù„Ø¨Ø¯Ø¡',
                goToCorner: 'Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ {corner}',
                complete: 'ØªÙ… Ø§Ù„Ø·ÙˆØ§Ù! ØªÙ‡Ø§Ù†ÙŠÙ†Ø§!',
                pause: 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø·ÙˆØ§Ù. Ø§Ø¶ØºØ· Ø§Ø³ØªØ¦Ù†Ø§Ù Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.'
            },
            ms: {
                start: 'Arahkan kamera ke gambar Kaabah untuk bermula',
                goToCorner: 'Pergi ke sudut {corner}',
                complete: 'Tawaf selesai! Tahniah!',
                pause: 'Tawaf dijeda. Tekan Sambung untuk meneruskan.'
            }
        };
        
        let currentLanguage = 'en';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            updateUI();
        });
        
        function checkCameraStatus() {
            // Check if camera is available
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // iOS Safari specific constraints
                const constraints = {
                    video: {
                        facingMode: 'environment', // Use back camera
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(function(stream) {
                        console.log('Camera is working');
                        updateStatus('Camera access granted', 'status-tracking');
                        // Don't update debug info here as it will be updated by AR.js loading
                    })
                    .catch(function(error) {
                        console.error('Camera error:', error);
                        debugInfo.textContent = 'Camera Status: âŒ ' + error.message;
                        debugInfo.style.color = '#f44336';
                        updateStatus('Camera access denied: ' + error.message, 'status-error');
                        
                        // Show user-friendly error message
                        if (error.name === 'NotAllowedError') {
                            alert('Please allow camera access to use the AR features. Go to Settings > Safari > Camera and allow access.');
                        } else if (error.name === 'NotFoundError') {
                            alert('No camera found on this device.');
                        }
                    });
            } else {
                debugInfo.textContent = 'Camera Status: âŒ Not supported';
                debugInfo.style.color = '#f44336';
                updateStatus('Camera not supported on this device', 'status-error');
            }
        }
        
        function testImageTracking() {
            // Simulate image tracking for testing
            console.log('Testing image tracking...');
            updateStatus('Testing tracking...', 'status-searching');
            
            // Simulate finding a marker after 2 seconds
            setTimeout(() => {
                console.log('ðŸŽ¯ Simulating marker detection...');
                updateStatus('ðŸŽ¯ Test: Kaaba detected!', 'status-tracking');
                
                // Trigger marker found event manually
                const marker = document.getElementById('kaabaMarker');
                if (marker) {
                    // Create and dispatch a custom marker found event
                    const event = new CustomEvent('markerFound', { detail: { marker: marker } });
                    marker.dispatchEvent(event);
                }
                
                showTawafUI();
                
                // Reset after 5 seconds
                setTimeout(() => {
                    updateStatus('Searching for Kaaba image...', 'status-searching');
                }, 5000);
            }, 2000);
        }
        
        function toggleVisualDebug() {
            const debugDiv = document.getElementById('visualDebug');
            if (debugDiv.style.display === 'none') {
                debugDiv.style.display = 'block';
                updateVisualDebug();
                // Update debug info every 2 seconds
                setInterval(updateVisualDebug, 2000);
            } else {
                debugDiv.style.display = 'none';
            }
        }
        
        function reloadLibraries() {
            console.log('Reloading libraries...');
            updateStatus('Reloading AR libraries...', 'status-searching');
            
            // Remove existing scripts
            const existingScripts = document.querySelectorAll('script[src*="aframe"]');
            existingScripts.forEach(script => script.remove());
            
            // Reload libraries
            setTimeout(() => {
                loadLibraries();
            }, 1000);
        }
        
        function updateVisualDebug() {
            const debugStatus = document.getElementById('debugStatus');
            const scene = document.querySelector('a-scene');
            const marker = document.getElementById('kaabaMarker');
            
            let status = '=== DEBUG STATUS ===\n';
            status += scene ? 'âœ… Scene: Loaded\n' : 'âŒ Scene: Missing\n';
            status += marker ? 'âœ… Marker: Found\n' : 'âŒ Marker: Missing\n';
            status += (typeof ARjs !== 'undefined') ? 'âœ… AR.js: Loaded\n' : 'âŒ AR.js: Missing\n';
            status += 'Camera: ' + (navigator.mediaDevices ? 'Available' : 'Not Available') + '\n';
            
            debugStatus.textContent = status;
        }
        
        function debugMarkerDetection() {
            console.log('=== MARKER DETECTION DEBUG ===');
            
            // Check if AR scene is loaded
            const scene = document.querySelector('a-scene');
            if (scene) {
                console.log('âœ… A-Frame scene found');
                console.log('Scene attributes:', scene.getAttributeNames());
            } else {
                console.log('âŒ A-Frame scene not found');
            }
            
            // Check if marker element exists
            const marker = document.getElementById('kaabaMarker');
            if (marker) {
                console.log('âœ… Marker element found');
                console.log('Marker attributes:', marker.getAttributeNames());
                console.log('Marker visible:', marker.getAttribute('visible'));
            } else {
                console.log('âŒ Marker element not found');
            }
            
            // Check AR.js status
            if (typeof ARjs !== 'undefined') {
                console.log('âœ… AR.js library loaded');
            } else {
                console.log('âŒ AR.js library not loaded');
            }
            
            // Check camera status
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                console.log('âœ… Camera API available');
            } else {
                console.log('âŒ Camera API not available');
            }
            
            // Show debug info to user
            let debugInfo = '=== DEBUG INFO ===\n';
            debugInfo += scene ? 'âœ… A-Frame scene found\n' : 'âŒ A-Frame scene not found\n';
            debugInfo += marker ? 'âœ… Marker element found\n' : 'âŒ Marker element not found\n';
            debugInfo += (typeof ARjs !== 'undefined') ? 'âœ… AR.js library loaded\n' : 'âŒ AR.js library not loaded\n';
            debugInfo += (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) ? 'âœ… Camera API available\n' : 'âŒ Camera API not available\n';
            
            alert(debugInfo);
        }
        
        function showSimpleCamera() {
            console.log('Showing simple camera feed...');
            
            // Hide the main menu
            mainMenu.style.display = 'none';
            
            // Create a simple video element
            const video = document.createElement('video');
            video.id = 'simpleCamera';
            video.autoplay = true;
            video.playsinline = true;
            video.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                object-fit: cover;
                z-index: 1;
            `;
            document.body.appendChild(video);
            
            // Start camera
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            })
            .then(stream => {
                video.srcObject = stream;
                console.log('Simple camera feed started');
                updateStatus('Simple camera feed active', 'status-tracking');
            })
            .catch(err => {
                console.error('Simple camera error:', err);
                updateStatus('Camera error: ' + err.message, 'status-error');
            });
        }
        
        function showARScene() {
            console.log('Manually showing AR scene...');
            
            // Hide the main menu
            mainMenu.style.display = 'none';
            
            // Show AR scene
            const arScene = document.getElementById('arScene');
            if (arScene) {
                arScene.style.display = 'block';
                console.log('AR scene displayed');
                updateStatus('AR scene active - point camera at hiro marker', 'status-searching');
                
                // Force AR scene to be visible and on top
                arScene.style.position = 'fixed';
                arScene.style.top = '0';
                arScene.style.left = '0';
                arScene.style.width = '100%';
                arScene.style.height = '100%';
                arScene.style.zIndex = '1';
                
                // Make sure A-Frame canvas is visible
                const canvas = document.querySelector('.a-canvas');
                if (canvas) {
                    canvas.style.display = 'block';
                    canvas.style.position = 'fixed';
                    canvas.style.top = '0';
                    canvas.style.left = '0';
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                    canvas.style.zIndex = '1';
                }
                
                console.log('AR scene and canvas should now be visible');
            } else {
                console.error('AR scene element not found');
            }
        }
        
        function testCamera() {
            console.log('Testing camera access...');
            updateStatus('Testing camera...', 'status-searching');
            
            // Force camera test
            checkCameraStatus();
            
            // Also try to show camera feed directly
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(stream => {
                        console.log('Camera test successful');
                        updateStatus('Camera test: SUCCESS', 'status-tracking');
                        
                        // Create a test video element
                        const testVideo = document.createElement('video');
                        testVideo.srcObject = stream;
                        testVideo.autoplay = true;
                        testVideo.playsinline = true;
                        testVideo.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                            z-index: 999;
                        `;
                        document.body.appendChild(testVideo);
                        
                        // Remove after 3 seconds
                        setTimeout(() => {
                            document.body.removeChild(testVideo);
                            stream.getTracks().forEach(track => track.stop());
                            updateStatus('Camera test completed', 'status-searching');
                        }, 3000);
                    })
                    .catch(error => {
                        console.error('Camera test failed:', error);
                        updateStatus('Camera test: FAILED - ' + error.message, 'status-error');
                        alert('Camera test failed: ' + error.message + '\n\nPlease check:\n1. Camera permissions in Safari\n2. HTTPS connection\n3. Device has camera');
                    });
            }
        }
        
        function toggleDebug() {
            debugMode = !debugMode;
            const scene = document.querySelector('a-scene');
            if (scene) {
                if (debugMode) {
                    scene.setAttribute('arjs', 'debugUIEnabled: true');
                    debugInfo.style.display = 'block';
                } else {
                    scene.setAttribute('arjs', 'debugUIEnabled: false');
                    debugInfo.style.display = 'none';
                }
            }
        }
        
        function setupAREvents() {
            console.log('Setting up AR events...');
            
            // Listen for marker detection
            const marker = document.getElementById('kaabaMarker');
            if (marker) {
                console.log('Marker element found, adding event listeners...');
                
                // Multiple event types for better detection
                marker.addEventListener('markerFound', function() {
                    console.log('ðŸŽ¯ MARKER FOUND!');
                    updateStatus('ðŸŽ¯ Kaaba detected!', 'status-tracking');
                    if (!isTawafActive) {
                        showTawafUI();
                    }
                    
                    // Add visual feedback
                    marker.setAttribute('visible', 'true');
                    
                    // Show success message
                    alert('ðŸŽ¯ Hiro marker detected! AR content should be visible.');
                });
                
                marker.addEventListener('markerLost', function() {
                    console.log('âŒ Marker lost!');
                    updateStatus('Searching for Kaaba image...', 'status-searching');
                    marker.setAttribute('visible', 'false');
                });
                
                // Add click event for testing
                marker.addEventListener('click', function() {
                    console.log('Marker clicked!');
                    showTawafUI();
                });
                
                // Add touch events for mobile
                marker.addEventListener('touchstart', function() {
                    console.log('Marker touched!');
                    showTawafUI();
                });
                
                console.log('AR event listeners added successfully');
            } else {
                console.error('Marker element not found!');
            }
            
            // Also listen for scene events
            const scene = document.querySelector('a-scene');
            if (scene) {
                scene.addEventListener('loaded', function() {
                    console.log('A-Frame scene loaded');
                });
                
                scene.addEventListener('camera-init', function() {
                    console.log('Camera initialized');
                });
                
                scene.addEventListener('camera-error', function(error) {
                    console.error('Camera error in scene:', error);
                });
                
                // Listen for AR.js specific events
                scene.addEventListener('arjs-nft-loaded', function() {
                    console.log('AR.js NFT loaded');
                });
                
                scene.addEventListener('arjs-marker-found', function(event) {
                    console.log('AR.js marker found event:', event);
                });
            }
            
            // Add global click handler for debugging
            document.addEventListener('click', function(event) {
                console.log('Global click event:', event.target);
            });
        }
        
        function updateStatus(text, className) {
            statusText.textContent = text;
            arStatus.className = 'ar-status ' + className;
        }
        
        function startTawaf() {
            showTawafUI();
        }
        
        function showTawafUI() {
            mainMenu.style.display = 'none';
            tawafUI.style.display = 'block';
            updateUI();
        }
        
        function showMainMenu() {
            mainMenu.style.display = 'block';
            tawafUI.style.display = 'none';
            settingsPanel.style.display = 'none';
            helpPanel.style.display = 'none';
            pauseTawaf();
        }
        
        function startTawafRoutine() {
            if (!isTawafActive) {
                isTawafActive = true;
                currentRound = 1;
                currentCorner = 0;
                startBtn.style.display = 'none';
                pauseBtn.style.display = 'inline-block';
                
                // Start the tawaf cycle
                tawafInterval = setInterval(advanceTawaf, 3000);
                
                // Play start guidance
                playGuidance('start');
                
                updateUI();
            }
        }
        
        function pauseTawaf() {
            isTawafActive = false;
            clearInterval(tawafInterval);
            startBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
            updateUI();
        }
        
        function resetTawaf() {
            pauseTawaf();
            currentRound = 0;
            currentCorner = 0;
            updateUI();
        }
        
        function advanceTawaf() {
            if (!isTawafActive) return;
            
            currentCorner++;
            
            if (currentCorner >= 4) {
                currentCorner = 0;
                currentRound++;
                
                if (currentRound > 7) {
                    // Tawaf completed
                    pauseTawaf();
                    playGuidance('complete');
                    instructionText.textContent = instructions[currentLanguage].complete;
                    return;
                }
            }
            
            // Play corner-specific prayer
            playPrayer(currentCorner);
            
            updateUI();
        }
        
        function updateUI() {
            roundText.textContent = `Round: ${currentRound}/7`;
            
            if (!isTawafActive) {
                instructionText.textContent = instructions[currentLanguage].start;
            } else {
                const cornerName = cornerNames[currentLanguage][currentCorner];
                instructionText.textContent = instructions[currentLanguage].goToCorner.replace('{corner}', cornerName);
            }
            
            // Update progress
            const progress = (currentRound - 1) / 7 + currentCorner / (7 * 4);
            progressFill.style.width = (progress * 100) + '%';
        }
        
        function playPrayer(cornerIndex) {
            // Simulate prayer audio (in real implementation, load actual audio files)
            console.log(`Playing prayer for corner ${cornerIndex}`);
            
            // Example audio URLs (replace with actual prayer audio files)
            const prayerUrls = [
                'audio/prayer_black_stone.mp3',
                'audio/prayer_yemen.mp3',
                'audio/prayer_shami.mp3',
                'audio/prayer_iraqi.mp3'
            ];
            
            if (prayerUrls[cornerIndex]) {
                prayerAudio.src = prayerUrls[cornerIndex];
                prayerAudio.volume = getPrayerVolume();
                prayerAudio.play().catch(e => console.log('Audio play failed:', e));
            }
        }
        
        function playGuidance(type) {
            // Simulate guidance audio
            console.log(`Playing guidance: ${type}`);
            
            const guidanceUrls = {
                'start': 'audio/guidance_start.mp3',
                'complete': 'audio/guidance_complete.mp3'
            };
            
            if (guidanceUrls[type]) {
                guidanceAudio.src = guidanceUrls[type];
                guidanceAudio.volume = getGuidanceVolume();
                guidanceAudio.play().catch(e => console.log('Audio play failed:', e));
            }
        }
        
        function showSettings() {
            settingsPanel.style.display = 'block';
        }
        
        function hideSettings() {
            settingsPanel.style.display = 'none';
        }
        
        function showHelp() {
            helpPanel.style.display = 'block';
        }
        
        function hideHelp() {
            helpPanel.style.display = 'none';
        }
        
        function saveSettings() {
            const masterVolume = document.getElementById('masterVolume').value;
            const prayerVolume = document.getElementById('prayerVolume').value;
            const guidanceVolume = document.getElementById('guidanceVolume').value;
            const language = document.getElementById('languageSelect').value;
            const subtitles = document.getElementById('subtitlesToggle').checked;
            
            localStorage.setItem('tawafAR_masterVolume', masterVolume);
            localStorage.setItem('tawafAR_prayerVolume', prayerVolume);
            localStorage.setItem('tawafAR_guidanceVolume', guidanceVolume);
            localStorage.setItem('tawafAR_language', language);
            localStorage.setItem('tawafAR_subtitles', subtitles);
            
            currentLanguage = language;
            updateUI();
            hideSettings();
        }
        
        function loadSettings() {
            const masterVolume = localStorage.getItem('tawafAR_masterVolume') || 1;
            const prayerVolume = localStorage.getItem('tawafAR_prayerVolume') || 0.8;
            const guidanceVolume = localStorage.getItem('tawafAR_guidanceVolume') || 0.6;
            const language = localStorage.getItem('tawafAR_language') || 'en';
            const subtitles = localStorage.getItem('tawafAR_subtitles') !== 'false';
            
            document.getElementById('masterVolume').value = masterVolume;
            document.getElementById('prayerVolume').value = prayerVolume;
            document.getElementById('guidanceVolume').value = guidanceVolume;
            document.getElementById('languageSelect').value = language;
            document.getElementById('subtitlesToggle').checked = subtitles;
            
            currentLanguage = language;
        }
        
        function getMasterVolume() {
            return parseFloat(document.getElementById('masterVolume').value);
        }
        
        function getPrayerVolume() {
            return parseFloat(document.getElementById('prayerVolume').value) * getMasterVolume();
        }
        
        function getGuidanceVolume() {
            return parseFloat(document.getElementById('guidanceVolume').value) * getMasterVolume();
        }
        
        // Handle volume changes
        document.getElementById('masterVolume').addEventListener('input', function() {
            prayerAudio.volume = getPrayerVolume();
            guidanceAudio.volume = getGuidanceVolume();
        });
        
        document.getElementById('prayerVolume').addEventListener('input', function() {
            prayerAudio.volume = getPrayerVolume();
        });
        
        document.getElementById('guidanceVolume').addEventListener('input', function() {
            guidanceAudio.volume = getGuidanceVolume();
        });
        
        document.getElementById('languageSelect').addEventListener('change', function() {
            currentLanguage = this.value;
            updateUI();
        });
        
        // Setup AR events after AR.js loads
        window.addEventListener('load', function() {
            setTimeout(function() {
                setupAREvents();
            }, 2000);
        });
    </script>
</body>
</html> 