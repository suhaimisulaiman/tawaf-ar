<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tawaf AR Trainer - MVP</title>
    
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <!-- AR.js -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@master/aframe/build/aframe-ar.min.js"></script>
    
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        .ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        .main-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            pointer-events: auto;
        }
        
        .tawaf-ui {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            pointer-events: auto;
            display: none;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .btn-secondary {
            background: #2196F3;
        }
        
        .btn-warning {
            background: #FF9800;
        }
        
        .status {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 2000;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .corner-info {
            font-size: 18px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .prayer-text {
            font-size: 14px;
            margin: 10px 0;
            font-style: italic;
        }
        
        .arabic-text {
            font-size: 18px;
            margin: 10px 0;
            font-weight: bold;
            direction: rtl;
            text-align: center;
            line-height: 1.5;
        }
        
        .translation-text {
            font-size: 14px;
            margin: 5px 0;
            font-style: italic;
            color: #CCCCCC;
        }
    </style>
</head>
<body>
    <!-- Status -->
    <div class="status" id="status">Loading...</div>
    
    <!-- Main Menu -->
    <div class="ui-overlay">
        <div class="main-menu" id="mainMenu">
            <h1>üïã Tawaf AR Trainer</h1>
            <p>Point camera at hiro marker to see Kaaba and begin Tawaf training</p>
        </div>
        
        <!-- Tawaf Training UI -->
        <div class="tawaf-ui" id="tawafUI">
            <div class="corner-info" id="cornerInfo">Point camera at Kaaba to start</div>
            <div class="arabic-text" id="arabicText">Ready to begin Tawaf training</div>
            <div class="translation-text" id="translationText">Ready to begin Tawaf training</div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div>
                <span id="roundText">Round: 0/7</span> | 
                <span id="cornerText">Corner: 0/4</span>
            </div>
            <div style="margin-top: 10px;">
                <button class="btn" id="startBtn" onclick="startTawaf()">Start Tawaf</button>
                <button class="btn btn-secondary" id="nextBtn" onclick="nextCorner()" style="display: none;">Next Corner</button>
                <button class="btn btn-warning" id="pauseBtn" onclick="pauseTawaf()" style="display: none;">Pause</button>
                <button class="btn btn-secondary" onclick="resetTawaf()">Reset</button>
                <button class="btn btn-secondary" onclick="showMainMenu()">Menu</button>
            </div>
            
            <!-- Smart Features Info -->
            <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                <div>üí° Smart Features: Auto-pause ‚Ä¢ Swipe to advance ‚Ä¢ Camera hints</div>
                <div>üëÜ Swipe right to advance corners</div>
            </div>
        </div>
    </div>
    
    <!-- AR Scene -->
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: true;">
        <!-- Hiro Marker -->
        <a-marker preset="hiro" id="kaabaMarker">
            <!-- Simple Black Kaaba -->
            <a-box position="0 0.5 0" 
                   width="1" 
                   height="1" 
                   depth="1" 
                   color="#000000"
                   material="shader: flat">
            </a-box>
            
            <!-- Corner Markers -->
            <!-- Black Stone (Black) -->
            <a-sphere position="0.8 0.5 0.8" 
                      radius="0.1" 
                      color="#000000"
                      id="corner0"
                      class="corner-marker">
            </a-sphere>
            
            <!-- Yemen Corner (Green) -->
            <a-sphere position="0.8 0.5 -0.8" 
                      radius="0.1" 
                      color="#4CAF50"
                      id="corner1"
                      class="corner-marker">
            </a-sphere>
            
            <!-- Shami Corner (Blue) -->
            <a-sphere position="-0.8 0.5 -0.8" 
                      radius="0.1" 
                      color="#2196F3"
                      id="corner2"
                      class="corner-marker">
            </a-sphere>
            
            <!-- Iraqi Corner (Red) -->
            <a-sphere position="-0.8 0.5 0.8" 
                      radius="0.1" 
                      color="#F44336"
                      id="corner3"
                      class="corner-marker">
            </a-sphere>
            
            <!-- Direction Arrow -->
            <a-cone position="0 0.3 1.5" 
                    rotation="0 0 0" 
                    radius-bottom="0.2" 
                    height="0.4" 
                    color="#FFD700"
                    id="directionArrow">
            </a-cone>
            
            <!-- Round Counter (Floating) -->
            <a-text position="0 1.5 0" 
                    value="Round: 0/7" 
                    color="#FFFFFF" 
                    align="center"
                    id="roundCounter">
            </a-text>
        </a-marker>
        
        <!-- Camera -->
        <a-entity camera></a-entity>
    </a-scene>
    
    <script>
        const status = document.getElementById('status');
        const mainMenu = document.getElementById('mainMenu');
        const tawafUI = document.getElementById('tawafUI');
        
        // Tawaf state
        let currentRound = 0;
        let currentCorner = 0;
        let isTawafActive = false;
        let isPaused = false;
        
        // Smart features state
        let isAutoPauseEnabled = true;
        let isGestureControlEnabled = true;
        let lastTouchTime = 0;
        let touchStartX = 0;
        let touchStartY = 0;
        
        // Corner data
        const corners = [
            {
                name: "Black Stone (Hajar Aswad)",
                prayer: "ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸêÿå ÿßŸÑŸÑŸéŸëŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿè. ÿßŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ÿ•ŸêŸäŸÖŸéÿßŸÜÿßŸã ÿ®ŸêŸÉŸéÿå ŸàŸéÿ™ŸéÿµŸíÿØŸêŸäŸÇÿßŸã ÿ®ŸêŸÉŸêÿ™Ÿéÿßÿ®ŸêŸÉŸéÿå ŸàŸéŸàŸéŸÅŸéÿßÿ°Ÿã ÿ®ŸêÿπŸéŸáŸíÿØŸêŸÉŸéÿå ŸàŸéÿßÿ™ŸêŸëÿ®ŸéÿßÿπÿßŸã ŸÑŸêÿ≥ŸèŸÜŸéŸëÿ©Ÿê ŸÜŸéÿ®ŸêŸäŸêŸëŸÉŸé ŸÖŸèÿ≠ŸéŸÖŸéŸëÿØŸç Ô∑∫",
                translation: "Dengan nama Allah, Allah Maha Besar. Ya Allah, aku beriman kepada-Mu, membenarkan kitab-Mu, memenuhi janji-Mu, dan mengikuti sunnah Nabi-Mu Muhammad Ô∑∫",
                color: "#000000"
            },
            {
                name: "Yemen Corner (Rukun Yamani)",
                prayer: "ÿ±Ÿéÿ®ŸéŸëŸÜŸéÿß ÿ¢ÿ™ŸêŸÜŸéÿß ŸÅŸêŸä ÿßŸÑÿØŸèŸëŸÜŸíŸäŸéÿß ÿ≠Ÿéÿ≥ŸéŸÜŸéÿ©Ÿã ŸàŸéŸÅŸêŸä ÿßŸÑŸíÿ¢ÿÆŸêÿ±Ÿéÿ©Ÿê ÿ≠Ÿéÿ≥ŸéŸÜŸéÿ©Ÿã ŸàŸéŸÇŸêŸÜŸéÿß ÿπŸéÿ∞Ÿéÿßÿ®Ÿé ÿßŸÑŸÜŸéŸëÿßÿ±Ÿê",
                translation: "Wahai Tuhan kami, berikanlah kepada kami kebaikan di dunia dan kebaikan di akhirat, dan peliharalah kami dari azab neraka",
                color: "#4CAF50"
            },
            {
                name: "Shami Corner (Rukun Shami)",
                prayer: "ÿßŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ÿßÿ∫ŸíŸÅŸêÿ±Ÿí ŸÑŸéŸÜŸéÿß ÿ∞ŸèŸÜŸèŸàÿ®ŸéŸÜŸéÿßÿå ŸàŸéÿßÿ≥Ÿíÿ™Ÿèÿ±Ÿí ÿπŸèŸäŸèŸàÿ®ŸéŸÜŸéÿßÿå ŸàŸéÿßÿ±Ÿíÿ≠ŸéŸÖŸíŸÜŸéÿßÿå ÿ£ŸéŸÜŸíÿ™Ÿé ÿ£Ÿéÿ±Ÿíÿ≠ŸéŸÖŸè ÿßŸÑÿ±ŸéŸëÿßÿ≠ŸêŸÖŸêŸäŸÜŸé",
                translation: "Ya Allah, ampunilah dosa-dosa kami, tutupilah keaiban kami, dan rahmatilah kami. Engkau adalah Yang Paling Penyayang di antara yang penyayang",
                color: "#2196F3"
            },
            {
                name: "Iraqi Corner (Rukun Iraqi)",
                prayer: "ÿßŸÑŸÑŸéŸëŸáŸèŸÖŸéŸë ÿ™ŸéŸÇŸéÿ®ŸéŸëŸÑŸí ŸÖŸêŸÜŸéŸëÿß ÿ∑ŸéŸàŸéÿßŸÅŸéŸÜŸéÿß ŸàŸéÿµŸéŸÑŸéÿßÿ™ŸéŸÜŸéÿß ŸàŸéÿØŸèÿπŸéÿßÿ°ŸéŸÜŸéÿßÿå ÿ•ŸêŸÜŸéŸëŸÉŸé ÿ£ŸéŸÜŸíÿ™Ÿé ÿßŸÑÿ≥ŸéŸëŸÖŸêŸäÿπŸè ÿßŸÑŸíÿπŸéŸÑŸêŸäŸÖŸè",
                translation: "Ya Allah, terimalah dari kami tawaf kami, solat kami, dan doa kami. Sesungguhnya Engkau Maha Mendengar lagi Maha Mengetahui",
                color: "#F44336"
            }
        ];
        
        // Update status
        function updateStatus(message) {
            status.textContent = message;
            console.log(message);
        }
        
        // Start Tawaf training
        function startTawaf() {
            if (!isTawafActive) {
                isTawafActive = true;
                currentRound = 1;
                currentCorner = 0;
                updateTawafUI();
                highlightCurrentCorner();
                updateStatus('Tawaf started - Round 1, Corner 1');
                
                // Enable smart features
                isAutoPauseEnabled = true;
                isGestureControlEnabled = true;
                
                // Provide initial guidance
                setTimeout(() => {
                    provideCameraHint();
                }, 1000);
            }
        }
        
        // Move to next corner
        function nextCorner() {
            if (!isTawafActive || isPaused) return;
            
            currentCorner++;
            
            // Check if round is complete
            if (currentCorner >= 4) {
                currentCorner = 0;
                currentRound++;
                
                // Show round completion animation
                showRoundCompletionAnimation();
                
                // Check if Tawaf is complete
                if (currentRound > 7) {
                    completeTawaf();
                    return;
                }
                
                updateStatus(`Round ${currentRound} completed! Starting Round ${currentRound + 1}`);
            }
            
            updateTawafUI();
            highlightCurrentCorner();
            updateStatus(`Round ${currentRound}/7, Corner ${currentCorner + 1}/4`);
        }
        
        // Complete Tawaf
        function completeTawaf() {
            isTawafActive = false;
            isPaused = false;
            
            const cornerInfo = document.getElementById('cornerInfo');
            const arabicText = document.getElementById('arabicText');
            const translationText = document.getElementById('translationText');
            
            cornerInfo.textContent = 'üéâ Tawaf Complete! üéâ';
            arabicText.textContent = 'ŸÖŸèÿ®Ÿéÿßÿ±ŸéŸÉŸå ÿπŸéŸÑŸéŸäŸíŸÉŸé! ŸÑŸéŸÇŸéÿØŸí ÿ£ŸéŸÉŸíŸÖŸéŸÑŸíÿ™Ÿé ÿßŸÑÿ∑ŸéŸëŸàŸéÿßŸÅŸé ÿßŸÑÿ≥ŸéŸëÿ®ŸíÿπŸéÿ©Ÿé';
            translationText.textContent = 'Tahniah! Anda telah menyelesaikan tujuh pusingan Tawaf.';
            
            updateStatus('Tawaf completed successfully!');
            
            // Update AR round counter to show completion
            const roundCounter = document.getElementById('roundCounter');
            if (roundCounter) {
                roundCounter.setAttribute('value', 'üéâ Complete! üéâ');
                roundCounter.setAttribute('color', '#FFD700');
            }
            
            // Hide control buttons
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'none';
        }
        
        // Show round completion animation
        function showRoundCompletionAnimation() {
            const roundCounter = document.getElementById('roundCounter');
            if (roundCounter) {
                // Simple color change for round completion
                roundCounter.setAttribute('color', '#FFD700');
                
                // Reset after 2 seconds
                setTimeout(() => {
                    roundCounter.setAttribute('color', '#FFFFFF');
                }, 2000);
            }
        }
        
        // Smart Features Functions
        
        // Provide camera-based hints
        function provideCameraHint() {
            if (!isTawafActive || isPaused) return;
            
            const corner = corners[currentCorner];
            const hints = [
                "Turn left to face Black Stone corner",
                "Continue counterclockwise to Yemen corner", 
                "Keep going to Shami corner",
                "Almost there - Iraqi corner next"
            ];
            
            const hint = hints[currentCorner];
            updateStatus(`üí° Hint: ${hint}`);
            
            // Show hint in UI
            const cornerInfo = document.getElementById('cornerInfo');
            if (cornerInfo) {
                cornerInfo.textContent = `${corner.name} - ${hint}`;
            }
        }
        
        // Auto-pause when marker is lost
        function handleMarkerLost() {
            if (isTawafActive && isAutoPauseEnabled && !isPaused) {
                isPaused = true;
                updateStatus('‚è∏Ô∏è Auto-paused: Marker lost. Resume when marker found.');
                
                // Update pause button
                const pauseBtn = document.getElementById('pauseBtn');
                if (pauseBtn) {
                    pauseBtn.textContent = 'Resume';
                }
            }
        }
        
        // Auto-resume when marker is found
        function handleMarkerFound() {
            if (isTawafActive && isPaused && isAutoPauseEnabled) {
                isPaused = false;
                updateStatus('‚ñ∂Ô∏è Auto-resumed: Marker found!');
                
                // Update pause button
                const pauseBtn = document.getElementById('pauseBtn');
                if (pauseBtn) {
                    pauseBtn.textContent = 'Pause';
                }
            }
        }
        
        // Gesture control for advancing corners
        function setupGestureControls() {
            if (!isGestureControlEnabled) return;
            
            // Touch events for swipe gestures
            document.addEventListener('touchstart', function(event) {
                if (!isTawafActive || isPaused) return;
                
                const touch = event.touches[0];
                touchStartX = touch.clientX;
                touchStartY = touch.clientY;
                lastTouchTime = Date.now();
            });
            
            document.addEventListener('touchend', function(event) {
                if (!isTawafActive || isPaused) return;
                
                const touch = event.changedTouches[0];
                const touchEndX = touch.clientX;
                const touchEndY = touch.clientY;
                const currentTime = Date.now();
                
                // Check if it's a quick swipe (less than 500ms)
                if (currentTime - lastTouchTime < 500) {
                    const deltaX = touchEndX - touchStartX;
                    const deltaY = touchEndY - touchStartY;
                    
                    // Horizontal swipe (left or right)
                    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                        if (deltaX > 0) {
                            // Swipe right - advance corner
                            nextCorner();
                            updateStatus('üëÜ Swipe detected: Advanced to next corner');
                        }
                    }
                }
            });
        }
        
        // Smart corner detection based on camera angle
        function detectCameraAngle() {
            if (!isTawafActive || isPaused) return;
            
            // This is a simplified version - in a real implementation,
            // you would use device orientation or camera position
            const corner = corners[currentCorner];
            
            // Provide contextual hints based on current corner
            setTimeout(() => {
                provideCameraHint();
            }, 2000); // Show hint after 2 seconds
        }
        
        // Toggle smart features
        function toggleAutoPause() {
            isAutoPauseEnabled = !isAutoPauseEnabled;
            updateStatus(`Auto-pause ${isAutoPauseEnabled ? 'enabled' : 'disabled'}`);
        }
        
        function toggleGestureControl() {
            isGestureControlEnabled = !isGestureControlEnabled;
            updateStatus(`Gesture control ${isGestureControlEnabled ? 'enabled' : 'disabled'}`);
        }
        
        // Provide smart guidance based on user behavior
        function provideSmartGuidance() {
            if (!isTawafActive || isPaused) return;
            
            const guidance = [
                "üí° Tip: Swipe right to advance corners",
                "üí° Tip: Keep the marker visible for best tracking",
                "üí° Tip: Move slowly around the Kaaba",
                "üí° Tip: Follow the golden arrow direction"
            ];
            
            const randomGuidance = guidance[Math.floor(Math.random() * guidance.length)];
            updateStatus(randomGuidance);
        }
        
        // Pause/Resume Tawaf
        function pauseTawaf() {
            if (!isTawafActive) return;
            
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (isPaused) {
                pauseBtn.textContent = 'Resume';
                updateStatus('Tawaf paused');
            } else {
                pauseBtn.textContent = 'Pause';
                updateStatus('Tawaf resumed');
            }
        }
        
        // Reset Tawaf
        function resetTawaf() {
            isTawafActive = false;
            isPaused = false;
            currentRound = 0;
            currentCorner = 0;
            updateTawafUI();
            resetCornerHighlights();
            updateStatus('Tawaf reset');
        }
        
        // Show main menu
        function showMainMenu() {
            mainMenu.style.display = 'block';
            tawafUI.style.display = 'none';
            resetTawaf();
        }
        
        // Update Tawaf UI
        function updateTawafUI() {
            const cornerInfo = document.getElementById('cornerInfo');
            const arabicText = document.getElementById('arabicText');
            const translationText = document.getElementById('translationText');
            const roundText = document.getElementById('roundText');
            const cornerText = document.getElementById('cornerText');
            const progressFill = document.getElementById('progressFill');
            const startBtn = document.getElementById('startBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (isTawafActive) {
                const corner = corners[currentCorner];
                cornerInfo.textContent = corner.name;
                arabicText.textContent = corner.prayer;
                translationText.textContent = corner.translation;
                
                startBtn.style.display = 'none';
                nextBtn.style.display = 'inline-block';
                pauseBtn.style.display = 'inline-block';
            } else {
                cornerInfo.textContent = 'Point camera at Kaaba to start';
                arabicText.textContent = 'Ready to begin Tawaf training';
                translationText.textContent = 'Ready to begin Tawaf training';
                
                startBtn.style.display = 'inline-block';
                nextBtn.style.display = 'none';
                pauseBtn.style.display = 'none';
            }
            
            roundText.textContent = `Round: ${currentRound}/7`;
            cornerText.textContent = `Corner: ${currentCorner + 1}/4`;
            
            // Update progress bar
            const totalSteps = 7 * 4; // 7 rounds * 4 corners
            const currentStep = (currentRound - 1) * 4 + currentCorner;
            const progress = (currentStep / totalSteps) * 100;
            progressFill.style.width = `${progress}%`;
            
            // Update AR round counter
            const roundCounter = document.getElementById('roundCounter');
            if (roundCounter) {
                roundCounter.setAttribute('value', `Round: ${currentRound}/7`);
            }
        }
        
        // Highlight current corner in AR
        function highlightCurrentCorner() {
            // Reset all corners
            resetCornerHighlights();
            
            // Highlight current corner with simple scaling
            const currentCornerElement = document.getElementById(`corner${currentCorner}`);
            if (currentCornerElement) {
                // Simple scale effect
                currentCornerElement.setAttribute('scale', '1.3 1.3 1.3');
                
                // Simple glow effect
                currentCornerElement.setAttribute('material', 'shader: flat; emissive: #FFFFFF; emissiveIntensity: 0.2');
            }
            
            // Update direction arrow
            updateDirectionArrow();
        }
        
        // Reset corner highlights
        function resetCornerHighlights() {
            for (let i = 0; i < 4; i++) {
                const corner = document.getElementById(`corner${i}`);
                if (corner) {
                    // Reset scale
                    corner.setAttribute('scale', '1 1 1');
                    
                    // Reset material
                    corner.setAttribute('material', 'shader: flat');
                }
            }
        }
        
        // Update direction arrow
        function updateDirectionArrow() {
            const arrow = document.getElementById('directionArrow');
            if (arrow) {
                // Rotate arrow to point to next corner
                const nextCorner = (currentCorner + 1) % 4;
                const rotations = [0, 90, 180, 270]; // Black Stone, Yemen, Shami, Iraqi
                arrow.setAttribute('rotation', `0 ${rotations[nextCorner]} 0`);
            }
        }
        
        // Setup marker events
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('App loaded - point camera at hiro marker');
            
            const marker = document.getElementById('kaabaMarker');
            if (marker) {
                marker.addEventListener('markerFound', function() {
                    updateStatus('üéØ Hiro marker detected! Tawaf training ready');
                    mainMenu.style.display = 'none';
                    tawafUI.style.display = 'block';
                    handleMarkerFound(); // Auto-resume when marker is found
                });
                
                marker.addEventListener('markerLost', function() {
                    updateStatus('Searching for hiro marker...');
                    mainMenu.style.display = 'block';
                    tawafUI.style.display = 'none';
                    handleMarkerLost(); // Auto-pause when marker is lost
                });
            }

            setupGestureControls(); // Setup gesture controls
            detectCameraAngle(); // Start camera angle detection
        });
    </script>
</body>
</html> 