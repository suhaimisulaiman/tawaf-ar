<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tawaf AR Trainer - MVP</title>
    
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <!-- AR.js -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@master/aframe/build/aframe-ar.min.js"></script>
    
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: transparent;
        }
        
        /* Ensure AR scene is visible */
        a-scene {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 1 !important;
        }
        
        .ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        .main-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            pointer-events: auto;
        }
        
        .tawaf-ui {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            pointer-events: auto;
            display: none;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .btn-secondary {
            background: #2196F3;
        }
        
        .btn-warning {
            background: #FF9800;
        }
        
        .status {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 2000;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .corner-info {
            font-size: 18px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .prayer-text {
            font-size: 14px;
            margin: 10px 0;
            font-style: italic;
        }
        
        .arabic-text {
            font-size: 18px;
            margin: 10px 0;
            font-weight: bold;
            direction: rtl;
            text-align: center;
            line-height: 1.5;
        }
        
        .translation-text {
            font-size: 14px;
            margin: 5px 0;
            font-style: italic;
            color: #CCCCCC;
        }

        /* Cognitive & Gestalt Principles */
        
        /* 1. PROXIMITY - Group related elements together */
        .control-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            justify-content: center;
        }
        
        /* 2. SIMILARITY - Use consistent colors and shapes */
        .btn-primary { background: #2196F3; }
        .btn-secondary { background: #757575; }
        .btn-success { background: #4CAF50; }
        .btn-warning { background: #FF9800; }
        .btn-danger { background: #F44336; }
        .btn-istilam { background: #9C27B0; }
        
        /* 3. CONTINUITY - Smooth transitions and flow */
        .smooth-transition {
            transition: all 0.3s ease-in-out;
        }
        
        /* 4. CLOSURE - Complete visual patterns */
        .progress-container {
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            background: #f5f5f5;
        }
        
        /* 5. FIGURE-GROUND - Clear hierarchy */
        .main-content {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            /* Removed backdrop-filter to prevent AR scene blocking */
        }
        
        /* 6. COMMON FATE - Elements moving together */
        .corner-group {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* 7. PRAGNANZ - Simple, clear shapes */
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-active { background: #4CAF50; }
        .status-paused { background: #FF9800; }
        .status-complete { background: #2196F3; }
        
        /* 8. COGNITIVE LOAD REDUCTION */
        .info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* 9. VISUAL HIERARCHY */
        .primary-text { font-size: 18px; font-weight: bold; }
        .secondary-text { font-size: 14px; opacity: 0.8; }
        .tertiary-text { font-size: 12px; opacity: 0.6; }
        
        /* 10. AFFORDANCE - Clear interactive elements */
        .interactive-element {
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .interactive-element:hover {
            border-color: #2196F3;
            transform: scale(1.05);
        }
        
        /* 11. MENTAL MODEL - Intuitive layout */
        .tawaf-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 15px 0;
        }
        
        .flow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .flow-arrow {
            font-size: 24px;
            color: #2196F3;
            margin: 0 10px;
        }
        
        /* 12. CHUNKING - Group information logically */
        .info-chunk {
            border-left: 4px solid #2196F3;
            padding-left: 15px;
            margin: 10px 0;
            background: rgba(33, 150, 243, 0.1);
            border-radius: 0 5px 5px 0;
        }
    </style>
</head>
<body>
    <!-- Status -->
    <div class="status" id="statusBar">Loading...</div>
    
    <!-- Main Menu -->
    <div id="mainMenu" class="main-content" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 30px; text-align: center; z-index: 1000;">
        <h1 class="primary-text" style="color: #2196F3; margin-bottom: 20px;">🕋 Tawaf AR Trainer</h1>
        
        <div class="info-card">
            <div class="primary-text">Islamic Tawaf Training</div>
            <div class="secondary-text">Learn the sacred ritual of Tawaf around the Kaaba</div>
        </div>
        
        <div class="info-chunk">
            <div class="secondary-text">📱 Point camera at hiro marker to begin</div>
            <div class="tertiary-text">7 rounds • 4 corners • AR guidance</div>
        </div>
        
        <div class="tawaf-flow">
            <div class="flow-step">
                <div class="status-indicator status-active"></div>
                <div class="secondary-text">Start</div>
            </div>
            <div class="flow-arrow">→</div>
            <div class="flow-step">
                <div class="status-indicator status-paused"></div>
                <div class="secondary-text">Tawaf</div>
            </div>
            <div class="flow-arrow">→</div>
            <div class="flow-step">
                <div class="status-indicator status-complete"></div>
                <div class="secondary-text">Complete</div>
            </div>
        </div>
        
        <div class="control-group">
            <button class="btn btn-primary interactive-element smooth-transition" onclick="showTawafUI()">
                🚀 Start Training
            </button>
        </div>
    </div>
    
            <!-- Tawaf Training UI -->
        <div id="tawafUI" class="main-content" style="position: fixed; bottom: 20px; left: 20px; right: 20px; padding: 20px; z-index: 1000; display: none;">
        <!-- Status Bar with Visual Hierarchy -->
        <div class="info-chunk">
            <div class="primary-text" id="cornerInfo">Point camera at Kaaba to start</div>
            <div class="secondary-text" id="status">Ready to begin Tawaf training</div>
        </div>
        
        <!-- Progress Information with Chunking -->
        <div class="control-group">
            <div class="flow-step">
                <div class="status-indicator status-active"></div>
                <div class="secondary-text" id="roundText">Round: 0/7</div>
            </div>
            <div class="flow-arrow">→</div>
            <div class="flow-step">
                <div class="status-indicator status-paused"></div>
                <div class="secondary-text" id="cornerText">Corner: 0/4</div>
            </div>
        </div>
        
        <!-- Progress Bar with Closure -->
        <div class="progress-container smooth-transition">
            <div id="progressFill" style="height: 8px; background: linear-gradient(90deg, #4CAF50, #2196F3); width: 0%; transition: width 0.5s ease;"></div>
        </div>
        
        <!-- Prayer Display with Figure-Ground -->
        <div class="info-card" style="margin: 15px 0;">
            <div class="arabic-text" id="arabicText" style="font-size: 16px; margin-bottom: 10px;">Ready to begin Tawaf training</div>
            <div class="translation-text" id="translationText" style="font-size: 14px; opacity: 0.9;">Ready to begin Tawaf training</div>
        </div>
        
        <!-- Control Buttons with Proximity and Similarity -->
        <div class="control-group">
            <button class="btn btn-primary interactive-element smooth-transition" id="startBtn" onclick="startTawaf()">Start Tawaf</button>
            <button class="btn btn-success interactive-element smooth-transition" id="nextBtn" onclick="nextCorner()" style="display: none;">Next Corner</button>
            <button class="btn btn-warning interactive-element smooth-transition" id="pauseBtn" onclick="pauseTawaf()" style="display: none;">Pause</button>
            <button class="btn btn-secondary interactive-element smooth-transition" onclick="resetTawaf()">Reset</button>
            <button class="btn btn-secondary interactive-element smooth-transition" onclick="showMainMenu()">Menu</button>
        </div>
        
        <!-- Istilam Button with Affordance -->
        <div class="control-group">
            <button class="btn btn-istilam interactive-element smooth-transition" id="istilamBtn" onclick="performIstilam()" style="display: none;">
                🖐️ Perform Istilam (Wave to Black Stone)
            </button>
        </div>
        
        <!-- Smart Features Info with Visual Hierarchy -->
        <div class="info-chunk">
            <div class="secondary-text">💡 Smart Features: Auto-pause • Swipe to advance • Camera hints • Istilam</div>
            <div class="tertiary-text">👆 Swipe right to advance corners • 🖐️ Perform Istilam at Black Stone</div>
        </div>
    </div>
    
    <!-- AR Scene -->
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: true;" style="z-index: 1; position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
        <!-- Hiro Marker -->
        <a-marker preset="hiro" id="kaabaMarker">
            <!-- Simple Black Kaaba -->
            <a-box position="0 0.5 0" 
                   width="1.5" 
                   height="1.5" 
                   depth="1.5" 
                   color="#000000"
                   material="shader: flat">
            </a-box>
            
            <!-- Corner Markers -->
            <!-- Black Stone (Black) -->
            <a-sphere position="1.2 0.75 1.2" 
                      radius="0.15" 
                      color="#000000"
                      id="corner0"
                      class="corner-marker">
            </a-sphere>
            
            <!-- Yemen Corner (Green) -->
            <a-sphere position="1.2 0.75 -1.2" 
                      radius="0.15" 
                      color="#4CAF50"
                      id="corner1"
                      class="corner-marker">
            </a-sphere>
            
            <!-- Shami Corner (Blue) -->
            <a-sphere position="-1.2 0.75 -1.2" 
                      radius="0.15" 
                      color="#2196F3"
                      id="corner2"
                      class="corner-marker">
            </a-sphere>
            
            <!-- Iraqi Corner (Red) -->
            <a-sphere position="-1.2 0.75 1.2" 
                      radius="0.15" 
                      color="#F44336"
                      id="corner3"
                      class="corner-marker">
            </a-sphere>
            
            <!-- Direction Arrow -->
            <a-cone position="0 0.45 2.25" 
                    rotation="0 0 0" 
                    radius-bottom="0.3" 
                    height="0.6" 
                    color="#FFD700"
                    id="directionArrow">
            </a-cone>
            
            <!-- Round Counter (Floating) -->
            <a-text position="0 2.25 0" 
                    value="Round: 0/7" 
                    color="#FFFFFF" 
                    align="center"
                    id="roundCounter">
            </a-text>
        </a-marker>
        
        <!-- Camera -->
        <a-entity camera></a-entity>
    </a-scene>
    
    <script>
        const status = document.getElementById('statusBar');
        const mainMenu = document.getElementById('mainMenu');
        const tawafUI = document.getElementById('tawafUI');
        
        // Tawaf state
        let currentRound = 0;
        let currentCorner = 0;
        let isTawafActive = false;
        let isPaused = false;
        
        // Smart features state
        let isAutoPauseEnabled = true;
        let isGestureControlEnabled = true;
        let lastTouchTime = 0;
        let touchStartX = 0;
        let touchStartY = 0;
        
        // Corner data
        const corners = [
            {
                name: "Black Stone (Hajar Aswad)",
                prayer: "بِسْمِ اللَّهِ، اللَّهُ أَكْبَرُ. اللَّهُمَّ إِيمَاناً بِكَ، وَتَصْدِيقاً بِكِتَابِكَ، وَوَفَاءً بِعَهْدِكَ، وَاتِّبَاعاً لِسُنَّةِ نَبِيِّكَ مُحَمَّدٍ ﷺ",
                translation: "Dengan nama Allah, Allah Maha Besar. Ya Allah, aku beriman kepada-Mu, membenarkan kitab-Mu, memenuhi janji-Mu, dan mengikuti sunnah Nabi-Mu Muhammad ﷺ",
                color: "#000000",
                requiresIstilam: true
            },
            {
                name: "Yemen Corner (Rukun Yamani)",
                prayer: "رَبَّنَا آتِنَا فِي الدُّنْيَا حَسَنَةً وَفِي الْآخِرَةِ حَسَنَةً وَقِنَا عَذَابَ النَّارِ",
                translation: "Wahai Tuhan kami, berikanlah kepada kami kebaikan di dunia dan kebaikan di akhirat, dan peliharalah kami dari azab neraka",
                color: "#4CAF50",
                requiresIstilam: false
            },
            {
                name: "Shami Corner (Rukun Shami)",
                prayer: "اللَّهُمَّ اغْفِرْ لَنَا ذُنُوبَنَا، وَاسْتُرْ عُيُوبَنَا، وَارْحَمْنَا، أَنْتَ أَرْحَمُ الرَّاحِمِينَ",
                translation: "Ya Allah, ampunilah dosa-dosa kami, tutupilah keaiban kami, dan rahmatilah kami. Engkau adalah Yang Paling Penyayang di antara yang penyayang",
                color: "#2196F3",
                requiresIstilam: false
            },
            {
                name: "Iraqi Corner (Rukun Iraqi)",
                prayer: "اللَّهُمَّ تَقَبَّلْ مِنَّا طَوَافَنَا وَصَلَاتَنَا وَدُعَاءَنَا، إِنَّكَ أَنْتَ السَّمِيعُ الْعَلِيمُ",
                translation: "Ya Allah, terimalah dari kami tawaf kami, solat kami, dan doa kami. Sesungguhnya Engkau Maha Mendengar lagi Maha Mengetahui",
                color: "#F44336",
                requiresIstilam: false
            }
        ];
        
        // Update status
        function updateStatus(message) {
            status.textContent = message;
            console.log(message);
        }
        
        // Start Tawaf training
        function startTawaf() {
            if (!isTawafActive) {
                isTawafActive = true;
                currentRound = 1;
                currentCorner = 0;
                updateTawafUI();
                highlightCurrentCorner();
                updateStatus('Tawaf started - Round 1, Corner 1');
                
                // Enable smart features
                isAutoPauseEnabled = true;
                isGestureControlEnabled = true;
                
                // Provide initial guidance
                setTimeout(() => {
                    provideCameraHint();
                }, 1000);
            }
        }
        
        // Move to next corner
        function nextCorner() {
            if (!isTawafActive || isPaused) return;
            
            currentCorner++;
            
            // Check if round is complete
            if (currentCorner >= 4) {
                currentCorner = 0;
                currentRound++;
                
                // Show round completion animation
                showRoundCompletionAnimation();
                
                // Check if Tawaf is complete
                if (currentRound > 7) {
                    completeTawaf();
                    return;
                }
                
                updateStatus(`Round ${currentRound} completed! Starting Round ${currentRound + 1}`);
            }
            
            updateTawafUI();
            highlightCurrentCorner();
            updateStatus(`Round ${currentRound}/7, Corner ${currentCorner + 1}/4`);
        }
        
        // Complete Tawaf
        function completeTawaf() {
            isTawafActive = false;
            isPaused = false;
            
            const cornerInfo = document.getElementById('cornerInfo');
            const arabicText = document.getElementById('arabicText');
            const translationText = document.getElementById('translationText');
            
            cornerInfo.textContent = '🎉 Tawaf Complete! 🎉';
            arabicText.textContent = 'مُبَارَكٌ عَلَيْكَ! لَقَدْ أَكْمَلْتَ الطَّوَافَ السَّبْعَةَ';
            translationText.textContent = 'Tahniah! Anda telah menyelesaikan tujuh pusingan Tawaf.';
            
            updateStatus('Tawaf completed successfully!');
            
            // Update AR round counter to show completion
            const roundCounter = document.getElementById('roundCounter');
            if (roundCounter) {
                roundCounter.setAttribute('value', '🎉 Complete! 🎉');
                roundCounter.setAttribute('color', '#FFD700');
            }
            
            // Hide control buttons
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'none';
        }
        
        // Show round completion animation
        function showRoundCompletionAnimation() {
            const roundCounter = document.getElementById('roundCounter');
            if (roundCounter) {
                // Simple color change for round completion
                roundCounter.setAttribute('color', '#FFD700');
                
                // Reset after 2 seconds
                setTimeout(() => {
                    roundCounter.setAttribute('color', '#FFFFFF');
                }, 2000);
            }
        }
        
        // Smart Features Functions
        
        // Provide camera-based hints
        function provideCameraHint() {
            if (!isTawafActive || isPaused) return;
            
            const corner = corners[currentCorner];
            let hints = [
                "Turn left to face Black Stone corner - Remember to perform Istilam (wave)",
                "Continue counterclockwise to Yemen corner", 
                "Keep going to Shami corner",
                "Almost there - Iraqi corner next"
            ];
            
            const hint = hints[currentCorner];
            updateStatus(`💡 Hint: ${hint}`);
            
            // Show hint in UI with Istilam reminder for Black Stone
            const cornerInfo = document.getElementById('cornerInfo');
            if (cornerInfo) {
                if (corner.requiresIstilam) {
                    cornerInfo.textContent = `${corner.name} - ${hint} - 🖐️ Perform Istilam`;
                } else {
                    cornerInfo.textContent = `${corner.name} - ${hint}`;
                }
            }
        }
        
        // Auto-pause when marker is lost
        function handleMarkerLost() {
            if (isTawafActive && isAutoPauseEnabled && !isPaused) {
                isPaused = true;
                updateStatus('⏸️ Auto-paused: Marker lost. Resume when marker found.');
                
                // Update pause button
                const pauseBtn = document.getElementById('pauseBtn');
                if (pauseBtn) {
                    pauseBtn.textContent = 'Resume';
                }
            }
        }
        
        // Auto-resume when marker is found
        function handleMarkerFound() {
            if (isTawafActive && isPaused && isAutoPauseEnabled) {
                isPaused = false;
                updateStatus('▶️ Auto-resumed: Marker found!');
                
                // Update pause button
                const pauseBtn = document.getElementById('pauseBtn');
                if (pauseBtn) {
                    pauseBtn.textContent = 'Pause';
                }
            }
        }
        
        // Gesture control for advancing corners
        function setupGestureControls() {
            if (!isGestureControlEnabled) return;
            
            // Touch events for swipe gestures
            document.addEventListener('touchstart', function(event) {
                if (!isTawafActive || isPaused) return;
                
                const touch = event.touches[0];
                touchStartX = touch.clientX;
                touchStartY = touch.clientY;
                lastTouchTime = Date.now();
            });
            
            document.addEventListener('touchend', function(event) {
                if (!isTawafActive || isPaused) return;
                
                const touch = event.changedTouches[0];
                const touchEndX = touch.clientX;
                const touchEndY = touch.clientY;
                const currentTime = Date.now();
                
                // Check if it's a quick swipe (less than 500ms)
                if (currentTime - lastTouchTime < 500) {
                    const deltaX = touchEndX - touchStartX;
                    const deltaY = touchEndY - touchStartY;
                    
                    // Horizontal swipe (left or right)
                    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                        if (deltaX > 0) {
                            // Swipe right - advance corner
                            nextCorner();
                            updateStatus('👆 Swipe detected: Advanced to next corner');
                        }
                    }
                }
            });
        }
        
        // Smart corner detection based on camera angle
        function detectCameraAngle() {
            if (!isTawafActive || isPaused) return;
            
            // This is a simplified version - in a real implementation,
            // you would use device orientation or camera position
            const corner = corners[currentCorner];
            
            // Provide contextual hints based on current corner
            setTimeout(() => {
                provideCameraHint();
            }, 2000); // Show hint after 2 seconds
        }
        
        // Toggle smart features
        function toggleAutoPause() {
            isAutoPauseEnabled = !isAutoPauseEnabled;
            updateStatus(`Auto-pause ${isAutoPauseEnabled ? 'enabled' : 'disabled'}`);
        }
        
        function toggleGestureControl() {
            isGestureControlEnabled = !isGestureControlEnabled;
            updateStatus(`Gesture control ${isGestureControlEnabled ? 'enabled' : 'disabled'}`);
        }
        
        // Provide smart guidance based on user behavior
        function provideSmartGuidance() {
            if (!isTawafActive || isPaused) return;
            
            const guidance = [
                "💡 Tip: Swipe right to advance corners",
                "💡 Tip: Keep the marker visible for best tracking",
                "💡 Tip: Move slowly around the Kaaba",
                "💡 Tip: Follow the golden arrow direction"
            ];
            
            const randomGuidance = guidance[Math.floor(Math.random() * guidance.length)];
            updateStatus(randomGuidance);
        }
        
        // Pause/Resume Tawaf
        function pauseTawaf() {
            if (!isTawafActive) return;
            
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (isPaused) {
                pauseBtn.textContent = 'Resume';
                updateStatus('Tawaf paused');
            } else {
                pauseBtn.textContent = 'Pause';
                updateStatus('Tawaf resumed');
            }
        }
        
        // Reset Tawaf
        function resetTawaf() {
            isTawafActive = false;
            isPaused = false;
            currentRound = 0;
            currentCorner = 0;
            updateTawafUI();
            resetCornerHighlights();
            updateStatus('Tawaf reset');
        }
        
        // Show main menu
        function showMainMenu() {
            mainMenu.style.display = 'block';
            tawafUI.style.display = 'none';
            resetTawaf();
        }

        // Show Tawaf UI
        function showTawafUI() {
            mainMenu.style.display = 'none';
            tawafUI.style.display = 'block';
            updateTawafUI(); // Ensure Tawaf UI is updated
            highlightCurrentCorner(); // Highlight the first corner
            updateStatus('Tawaf training started!');
        }
        
        // Update Tawaf UI with Cognitive & Gestalt Principles
        function updateTawafUI() {
            const cornerInfo = document.getElementById('cornerInfo');
            const arabicText = document.getElementById('arabicText');
            const translationText = document.getElementById('translationText');
            const roundText = document.getElementById('roundText');
            const cornerText = document.getElementById('cornerText');
            const progressFill = document.getElementById('progressFill');
            const startBtn = document.getElementById('startBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const istilamBtn = document.getElementById('istilamBtn');
            
            if (isTawafActive) {
                const corner = corners[currentCorner];
                
                // Apply cognitive principles
                updateVisualState();
                updateMentalModel();
                animateCornerGroup();
                updateInformationChunks();
                
                // Update prayer text with visual hierarchy
                arabicText.textContent = corner.prayer;
                translationText.textContent = corner.translation;
                
                // Button states with affordance
                startBtn.style.display = 'none';
                nextBtn.style.display = 'inline-block';
                pauseBtn.style.display = 'inline-block';
                istilamBtn.style.display = corner.requiresIstilam ? 'inline-block' : 'none';
                
                // Apply smooth transitions
                startBtn.className = 'btn btn-primary interactive-element smooth-transition';
                nextBtn.className = 'btn btn-success interactive-element smooth-transition';
                pauseBtn.className = 'btn btn-warning interactive-element smooth-transition';
                istilamBtn.className = 'btn btn-istilam interactive-element smooth-transition';
            } else {
                // Reset to initial state
                cornerInfo.textContent = 'Point camera at Kaaba to start';
                arabicText.textContent = 'Ready to begin Tawaf training';
                translationText.textContent = 'Ready to begin Tawaf training';
                
                startBtn.style.display = 'inline-block';
                nextBtn.style.display = 'none';
                pauseBtn.style.display = 'none';
                istilamBtn.style.display = 'none';
                
                // Reset visual state
                updateVisualState();
                updateMentalModel();
            }
            
            // Update progress with visual feedback
            roundText.textContent = `Round: ${currentRound}/7`;
            cornerText.textContent = `Corner: ${currentCorner + 1}/4`;
            
            // Progress bar with smooth animation
            const totalSteps = 7 * 4; // 7 rounds * 4 corners
            const currentStep = (currentRound - 1) * 4 + currentCorner;
            const progress = (currentStep / totalSteps) * 100;
            progressFill.style.width = `${progress}%`;
            
            // Update AR round counter
            const roundCounter = document.getElementById('roundCounter');
            if (roundCounter) {
                roundCounter.setAttribute('value', `Round: ${currentRound}/7`);
            }
        }
        
        // Highlight current corner in AR
        function highlightCurrentCorner() {
            // Reset all corners
            resetCornerHighlights();
            
            // Highlight current corner with simple scaling
            const currentCornerElement = document.getElementById(`corner${currentCorner}`);
            if (currentCornerElement) {
                // Simple scale effect
                currentCornerElement.setAttribute('scale', '1.3 1.3 1.3');
                
                // Simple glow effect
                currentCornerElement.setAttribute('material', 'shader: flat; emissive: #FFFFFF; emissiveIntensity: 0.2');
            }
            
            // Update direction arrow
            updateDirectionArrow();
        }
        
        // Reset corner highlights
        function resetCornerHighlights() {
            for (let i = 0; i < 4; i++) {
                const corner = document.getElementById(`corner${i}`);
                if (corner) {
                    // Reset scale
                    corner.setAttribute('scale', '1 1 1');
                    
                    // Reset material
                    corner.setAttribute('material', 'shader: flat');
                }
            }
        }
        
        // Update direction arrow
        function updateDirectionArrow() {
            const arrow = document.getElementById('directionArrow');
            if (arrow) {
                // Rotate arrow to point to next corner
                const nextCorner = (currentCorner + 1) % 4;
                const rotations = [0, 90, 180, 270]; // Black Stone, Yemen, Shami, Iraqi
                arrow.setAttribute('rotation', `0 ${rotations[nextCorner]} 0`);
            }
        }

        // Perform Istilam (Wave to Black Stone)
        function performIstilam() {
            if (!isTawafActive || isPaused) return;

            const corner = corners[currentCorner];
            if (corner.name === "Black Stone (Hajar Aswad)" && corner.requiresIstilam) {
                updateStatus('👋 Performing Istilam (Wave to Black Stone)');
                
                // Add a visual effect for the wave
                const blackStone = document.getElementById('corner0');
                if (blackStone) {
                    blackStone.setAttribute('scale', '1.5 1.5 1.5'); // Slightly larger
                    blackStone.setAttribute('material', 'shader: flat; emissive: #FFD700; emissiveIntensity: 0.5'); // Golden glow
                    setTimeout(() => {
                        blackStone.setAttribute('scale', '1.3 1.3 1.3'); // Reset scale
                        blackStone.setAttribute('material', 'shader: flat; emissive: #FFFFFF; emissiveIntensity: 0.2'); // Reset glow
                    }, 1000); // Duration of the wave effect
                }
                
                // Show Istilam guidance
                const cornerInfo = document.getElementById('cornerInfo');
                if (cornerInfo) {
                    cornerInfo.textContent = '👋 Istilam performed! Wave towards Black Stone';
                }
                
                updateStatus('✅ Istilam completed! You may now proceed to next corner.');
            } else {
                updateStatus('Istilam is only performed at the Black Stone corner.');
            }
        }
        
        // Cognitive Load Reduction & Mental Model Improvements
        
        // Visual feedback for current state
        function updateVisualState() {
            const statusIndicator = document.querySelector('.status-indicator');
            const roundText = document.getElementById('roundText');
            const cornerText = document.getElementById('cornerText');
            
            if (isTawafActive) {
                if (isPaused) {
                    statusIndicator.className = 'status-indicator status-paused';
                    statusIndicator.style.background = '#FF9800';
                } else {
                    statusIndicator.className = 'status-indicator status-active';
                    statusIndicator.style.background = '#4CAF50';
                }
            } else {
                statusIndicator.className = 'status-indicator status-complete';
                statusIndicator.style.background = '#2196F3';
            }
            
            // Update text with visual hierarchy
            if (roundText) roundText.className = 'secondary-text';
            if (cornerText) cornerText.className = 'secondary-text';
        }
        
        // Simplified mental model - show only relevant information
        function updateMentalModel() {
            const corner = corners[currentCorner];
            const cornerInfo = document.getElementById('cornerInfo');
            const statusElement = document.getElementById('statusBar');
            
            if (isTawafActive) {
                // Show current action needed
                if (corner.requiresIstilam) {
                    cornerInfo.textContent = `🖐️ ${corner.name} - Perform Istilam`;
                    if (statusElement) statusElement.textContent = 'Wave towards Black Stone to show respect';
                } else {
                    cornerInfo.textContent = `📍 ${corner.name}`;
                    if (statusElement) statusElement.textContent = 'Recite the prayer and proceed to next corner';
                }
            } else {
                cornerInfo.textContent = 'Point camera at Kaaba to start';
                if (statusElement) statusElement.textContent = 'Ready to begin Tawaf training';
            }
        }
        
        // Gestalt Principle: Common Fate - animate related elements together
        function animateCornerGroup() {
            const currentCornerElement = document.getElementById(`corner${currentCorner}`);
            if (currentCornerElement) {
                currentCornerElement.classList.add('corner-group');
                
                // Remove animation from other corners
                for (let i = 0; i < 4; i++) {
                    if (i !== currentCorner) {
                        const corner = document.getElementById(`corner${i}`);
                        if (corner) corner.classList.remove('corner-group');
                    }
                }
            }
        }
        
        // Cognitive Principle: Chunking - group information logically
        function updateInformationChunks() {
            const prayerCard = document.querySelector('.info-card');
            if (prayerCard && isTawafActive) {
                const corner = corners[currentCorner];
                
                // Add visual chunking with borders
                prayerCard.style.borderLeft = '4px solid #2196F3';
                prayerCard.style.borderRadius = '0 10px 10px 0';
                
                // Show chunked information
                const arabicText = document.getElementById('arabicText');
                const translationText = document.getElementById('translationText');
                
                if (arabicText) arabicText.className = 'arabic-text primary-text';
                if (translationText) translationText.className = 'translation-text secondary-text';
            }
        }
        
        // Setup marker events
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('App loaded - point camera at hiro marker');
            
            const marker = document.getElementById('kaabaMarker');
            if (marker) {
                marker.addEventListener('markerFound', function() {
                    updateStatus('🎯 Hiro marker detected! Tawaf training ready');
                    // showTawafUI(); // This will be handled by the new main menu
                    handleMarkerFound(); // Auto-resume when marker is found
                });
                
                marker.addEventListener('markerLost', function() {
                    updateStatus('Searching for hiro marker...');
                    // showMainMenu(); // This will be handled by the new main menu
                    handleMarkerLost(); // Auto-pause when marker is lost
                });
            }

            setupGestureControls(); // Setup gesture controls
            detectCameraAngle(); // Start camera angle detection
        });
    </script>
</body>
</html> 